{% extends 'sportshop/base.html' %}
{% load static %}

{% block content %}
<div class="search-container">
    <div class="search-header">
        <h1>Расширенный поиск</h1>
        <p>Найдите нужный товар с помощью фильтров</p>
    </div>

    <div class="search-layout">
        <!-- Фильтры -->
        <div class="filters-sidebar">
            <form method="get" action="{% url 'advanced_search' %}" class="filters-form">
                <div class="filter-section">
                    <h3>Категория</h3>
                    <select name="category" class="filter-select">
                        <option value="all">Все категории</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}"
                                {% if filters.category == category.id|stringformat:"i" %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-section">
                    <h3>Цена</h3>
                    <div class="price-range">
                        <input type="number" name="price_min" placeholder="От"
                               value="{{ filters.price_min|default:'' }}" class="price-input">
                        <span>-</span>
                        <input type="number" name="price_max" placeholder="До"
                               value="{{ filters.price_max|default:'' }}" class="price-input">
                    </div>
                </div>

                <div class="filter-section">
                    <h3>Бренд</h3>
                    <select name="brand" class="filter-select">
                        <option value="all">Все бренды</option>
                        {% for brand in brands %}
                        <option value="{{ brand }}"
                                {% if filters.brand == brand %}selected{% endif %}>
                            {{ brand }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-section">
                    <h3>Наличие</h3>
                    <label class="checkbox-label">
                        <input type="checkbox" name="in_stock" value="true"
                               {% if filters.in_stock == 'true' %}checked{% endif %}>
                        Только в наличии
                    </label>
                </div>

                <div class="filter-section">
                    <h3>Скидки</h3>
                    <label class="checkbox-label">
                        <input type="checkbox" name="has_discount" value="true"
                               {% if filters.has_discount == 'true' %}checked{% endif %}>
                        Только со скидкой
                    </label>
                </div>

                <button type="submit" class="btn-apply-filters">
                    <i class="fas fa-search"></i> Применить фильтры
                </button>
                <a href="{% url 'advanced_search' %}" class="btn-clear-filters">
                    Сбросить фильтры
                </a>
            </form>
        </div>

        <!-- Результаты -->
        <div class="search-results">
            <div class="results-header">
                <div class="results-info">
                    <h2>Найдено товаров: {{ results_count }}</h2>
                    {% if has_filters %}
                    <div class="active-filters">
                        {% if filters.q %}
                        <span class="filter-tag">Поиск: "{{ filters.q }}"</span>
                        {% endif %}
                        {% if filters.category and filters.category != 'all' %}
                        <span class="filter-tag">
                            Категория: {{ filters.category }}
                        </span>
                        {% endif %}
                        {% if filters.has_discount %}
                        <span class="filter-tag">Со скидкой</span>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                <div class="sort-controls">
                    <select name="sort" onchange="this.form.submit()" class="sort-select">
                        <option value="-created_at" {% if filters.sort == '-created_at' %}selected{% endif %}>
                            Сначала новые
                        </option>
                        <option value="created_at" {% if filters.sort == 'created_at' %}selected{% endif %}>
                            Сначала старые
                        </option>
                        <option value="price_asc" {% if filters.sort == 'price_asc' %}selected{% endif %}>
                            Цена по возрастанию
                        </option>
                        <option value="price_desc" {% if filters.sort == 'price_desc' %}selected{% endif %}>
                            Цена по убыванию
                        </option>
                        <option value="rating" {% if filters.sort == 'rating' %}selected{% endif %}>
                            По рейтингу
                        </option>
                        <option value="popular" {% if filters.sort == 'popular' %}selected{% endif %}>
                            Популярные
                        </option>
                    </select>
                </div>
            </div>

            {% if products %}
            <div class="products-grid">
                {% for product in products %}
                <div class="product-card">
                    <a href="{% url 'product_detail' product.id %}" class="product-image">
                        {% if product.image %}
                            <img src="{{ product.image.url }}" alt="{{ product.name }}">
                        {% else %}
                            <div class="no-image-placeholder">
                                <i class="fas fa-image"></i>
                                <span>Нет изображения</span>
                            </div>
                        {% endif %}
                        {% if product.discount_price %}
                        <span class="discount-badge">-{{ product.get_discount_percentage }}%</span>
                        {% endif %}
                    </a>

                    <div class="product-info">
                        <a href="{% url 'product_detail' product.id %}" class="product-name">
                            <h3>{{ product.name|truncatechars:50 }}</h3>
                        </a>

                        <div class="product-meta">
                            <span class="product-category">
                                {{ product.category.name|default:"Без категории" }}
                            </span>
                            {% if product.brand %}
                            <span class="product-brand">{{ product.brand }}</span>
                            {% endif %}
                        </div>

                        <div class="product-price">
                            {% if product.discount_price %}
                            <span class="price-old">{{ product.price }} ₽</span>
                            <span class="price-new">{{ product.discount_price }} ₽</span>
                            {% else %}
                            <span class="price-current">{{ product.price }} ₽</span>
                            {% endif %}
                        </div>

                        <div class="product-rating">
                            <div class="stars">
                                {% with rating=product.rating|default:0 %}
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= rating %}★{% else %}☆{% endif %}
                                    {% endfor %}
                                {% endwith %}
                            </div>
                            <span class="rating-value">{{ product.rating|default:"0.0" }}</span>
                        </div>

                        <div class="product-actions">
                            {% if product.in_stock %}
                            <button class="btn-add-to-cart" data-product-id="{{ product.id }}">
                                <i class="fas fa-shopping-cart"></i> В корзину
                            </button>
                            {% else %}
                            <button class="btn-out-of-stock" disabled>
                                Нет в наличии
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Пагинация -->
            {% if products.has_other_pages %}
            <div class="pagination">
                {% if products.has_previous %}
                <a href="?{% for key, value in filters.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ products.previous_page_number }}"
                   class="page-link">← Назад</a>
                {% endif %}

                {% for num in products.paginator.page_range %}
                    {% if products.number == num %}
                    <span class="page-current">{{ num }}</span>
                    {% elif num > products.number|add:'-3' and num < products.number|add:'3' %}
                    <a href="?{% for key, value in filters.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}"
                       class="page-link">{{ num }}</a>
                    {% endif %}
                {% endfor %}

                {% if products.has_next %}
                <a href="?{% for key, value in filters.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ products.next_page_number }}"
                   class="page-link">Вперед →</a>
                {% endif %}
            </div>
            {% endif %}

            {% else %}
            <div class="no-results">
                <i class="fas fa-search"></i>
                <h3>Товары не найдены</h3>
                <p>Попробуйте изменить параметры поиска или сбросить фильтры</p>
                <a href="{% url 'advanced_search' %}" class="btn-clear-search">
                    Сбросить фильтры
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.search-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.search-header {
    text-align: center;
    margin-bottom: 40px;
    padding: 20px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
}

.search-layout {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 30px;
}

.filters-sidebar {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    height: fit-content;
}

.filter-section {
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 1px solid #eee;
}

.filter-section:last-child {
    border-bottom: none;
}

.filter-section h3 {
    margin: 0 0 15px 0;
    font-size: 16px;
    color: #333;
}

.filter-select, .sort-select {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.price-range {
    display: flex;
    align-items: center;
    gap: 10px;
}

.price-input {
    flex: 1;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
}

.checkbox-label input {
    width: 18px;
    height: 18px;
}

.btn-apply-filters {
    width: 100%;
    padding: 12px;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.btn-clear-filters {
    display: block;
    text-align: center;
    color: #666;
    text-decoration: none;
    padding: 10px;
    border-radius: 4px;
    border: 1px solid #ddd;
}

.search-results {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
}

.results-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 30px;
}

.active-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

.filter-tag {
    background: #e9ecef;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 12px;
    color: #495057;
}

.products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.product-card {
    background: white;
    border: 1px solid #eee;
    border-radius: 8px;
    overflow: hidden;
    transition: transform 0.3s;
}

.product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.product-image {
    display: block;
    height: 200px;
    position: relative;
    overflow: hidden;
}

.product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.discount-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #dc3545;
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
}

.product-info {
    padding: 15px;
}

.product-name h3 {
    margin: 0 0 10px 0;
    font-size: 14px;
    color: #333;
    line-height: 1.4;
}

.product-meta {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: #666;
    margin-bottom: 10px;
}

.product-price {
    margin: 10px 0;
}

.price-old {
    text-decoration: line-through;
    color: #999;
    font-size: 14px;
    margin-right: 10px;
}

.price-new {
    color: #dc3545;
    font-size: 18px;
    font-weight: bold;
}

.price-current {
    color: #333;
    font-size: 18px;
    font-weight: bold;
}

.product-rating {
    display: flex;
    align-items: center;
    gap: 5px;
    margin: 10px 0;
}

.stars {
    color: #ffc107;
}

.rating-value {
    font-weight: bold;
    font-size: 14px;
}

.product-actions {
    margin-top: 15px;
}

.btn-add-to-cart {
    width: 100%;
    padding: 8px;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

.btn-out-of-stock {
    width: 100%;
    padding: 8px;
    background: #6c757d;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: not-allowed;
    font-size: 14px;
}

.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-top: 30px;
}

.page-link, .page-current {
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 14px;
}

.page-link {
    background: #f8f9fa;
    color: #667eea;
    text-decoration: none;
    border: 1px solid #dee2e6;
}

.page-current {
    background: #667eea;
    color: white;
}

.no-results {
    text-align: center;
    padding: 60px 20px;
}

.no-results i {
    font-size: 48px;
    color: #6c757d;
    margin-bottom: 20px;
}

.no-results h3 {
    margin: 0 0 10px 0;
    color: #333;
}

.no-results p {
    color: #666;
    margin-bottom: 20px;
}

.btn-clear-search {
    display: inline-block;
    padding: 10px 20px;
    background: #667eea;
    color: white;
    text-decoration: none;
    border-radius: 4px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Обработка формы сортировки
    const sortSelect = document.querySelector('.sort-select');
    const form = sortSelect.closest('form') || document.querySelector('.filters-form');

    sortSelect.addEventListener('change', function() {
        form.submit();
    });

    // Обработка добавления в корзину
    document.querySelectorAll('.btn-add-to-cart').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.dataset.productId;
            // Используйте существующий код из index.html для добавления в корзину
            console.log('Добавить в корзину товар:', productId);
        });
    });
});
</script>
{% endblock %}