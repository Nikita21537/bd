<!-- sportshop/templates/sportshop/checkout.html -->
{% extends 'sportshop/base.html' %}
{% load static %}

{% block content %}
<div class="checkout-page">
    <!-- Хлебные крошки -->
    <nav class="breadcrumbs">
        <div class="container">
            <a href="{% url 'index' %}">Главная</a> /
            <a href="{% url 'cart' %}">Корзина</a> /
            <span class="current">Оформление заказа</span>
        </div>
    </nav>

    <div class="container">
        <div class="checkout-wrapper">
            <!-- Шаги оформления -->
            <div class="checkout-steps">
                <div class="step completed">
                    <div class="step-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="step-info">
                        <div class="step-number">1</div>
                        <div class="step-title">Корзина</div>
                    </div>
                </div>
                <div class="step-divider">
                    <i class="fas fa-chevron-right"></i>
                </div>
                <div class="step active">
                    <div class="step-icon">
                        <i class="fas fa-edit"></i>
                    </div>
                    <div class="step-info">
                        <div class="step-number">2</div>
                        <div class="step-title">Оформление</div>
                    </div>
                </div>
                <div class="step-divider">
                    <i class="fas fa-chevron-right"></i>
                </div>
                <div class="step">
                    <div class="step-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="step-info">
                        <div class="step-number">3</div>
                        <div class="step-title">Подтверждение</div>
                    </div>
                </div>
            </div>

            <div class="checkout-main">
                <!-- Левая колонка: Форма -->
                <div class="checkout-left">
                    <form method="post" id="checkout-form" class="checkout-form">
                        {% csrf_token %}

                        <!-- Блок 1: Контактная информация -->
                        <section class="checkout-section">
                            <div class="section-header">
                                <h2><i class="fas fa-user"></i> Контактная информация</h2>
                            </div>

                            <div class="section-body">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="first_name">Имя *</label>
                                        <input type="text" id="first_name" name="first_name"
                                               value="{{ user.first_name|default:'' }}"
                                               class="form-input" required>
                                        <div class="form-error"></div>
                                    </div>

                                    <div class="form-group">
                                        <label for="last_name">Фамилия *</label>
                                        <input type="text" id="last_name" name="last_name"
                                               value="{{ user.last_name|default:'' }}"
                                               class="form-input" required>
                                        <div class="form-error"></div>
                                    </div>

                                    <div class="form-group">
                                        <label for="email">Email *</label>
                                        <input type="email" id="email" name="email"
                                               value="{{ user.email|default:'' }}"
                                               class="form-input" required>
                                        <div class="form-hint">На этот email придет подтверждение заказа</div>
                                        <div class="form-error"></div>
                                    </div>

                                    <div class="form-group">
                                        <label for="phone">Телефон *</label>
                                        <input type="tel" id="phone" name="phone"
                                               value="{{ user.profile.phone|default:'' }}"
                                               class="form-input" required
                                               placeholder="+7 (___) ___-__-__">
                                        <div class="form-error"></div>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- Блок 2: Адрес доставки -->
                        <section class="checkout-section">
                            <div class="section-header">
                                <h2><i class="fas fa-map-marker-alt"></i> Адрес доставки</h2>
                            </div>

                            <div class="section-body">
                                {% if user.addresses.exists %}
                                <div class="saved-addresses">
                                    <h4>Выберите сохраненный адрес:</h4>
                                    <div class="address-list">
                                        {% for address in user.addresses.all %}
                                        <div class="address-item" data-address-id="{{ address.id }}">
                                            <label class="address-select">
                                                <input type="radio" name="address_id"
                                                       value="{{ address.id }}"
                                                       {% if address.is_default %}checked{% endif %}>
                                                <div class="address-content">
                                                    <div class="address-name">{{ address.name }}</div>
                                                    <div class="address-details">
                                                        {{ address.get_full_address }}
                                                    </div>
                                                    <div class="address-contact">
                                                        {{ address.recipient_name }} • {{ address.phone }}
                                                    </div>
                                                </div>
                                            </label>
                                            <div class="address-actions">
                                                <button type="button" class="btn-edit-address"
                                                        onclick="editAddress({{ address.id }})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}

                                <button type="button" class="btn-add-address" id="show-address-form">
                                    <i class="fas fa-plus"></i> Добавить новый адрес
                                </button>

                                <!-- Форма нового адреса -->
                                <div class="new-address-form" id="new-address-form" style="display: none;">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label for="address_name">Название адреса</label>
                                            <input type="text" id="address_name" name="address_name"
                                                   class="form-input" placeholder="Дом, Работа, Квартира">
                                        </div>

                                        <div class="form-group">
                                            <label for="address_city">Город *</label>
                                            <input type="text" id="address_city" name="address_city"
                                                   class="form-input" required>
                                        </div>

                                        <div class="form-group">
                                            <label for="address_street">Улица, дом, квартира *</label>
                                            <textarea id="address_street" name="address_street"
                                                      class="form-input" rows="2" required></textarea>
                                        </div>

                                        <div class="form-group">
                                            <label for="address_postal_code">Индекс</label>
                                            <input type="text" id="address_postal_code"
                                                   name="address_postal_code" class="form-input">
                                        </div>

                                        <div class="form-group">
                                            <label for="address_recipient">Получатель</label>
                                            <input type="text" id="address_recipient"
                                                   name="address_recipient" class="form-input"
                                                   value="{{ user.get_full_name|default:user.username }}">
                                        </div>

                                        <div class="form-group">
                                            <label for="address_phone">Телефон получателя</label>
                                            <input type="tel" id="address_phone"
                                                   name="address_phone" class="form-input">
                                        </div>
                                    </div>

                                    <div class="form-options">
                                        <label class="checkbox">
                                            <input type="checkbox" name="save_new_address"
                                                   id="save_new_address" checked>
                                            <span class="checkmark"></span>
                                            <span class="checkbox-label">Сохранить адрес для будущих заказов</span>
                                        </label>

                                        <label class="checkbox">
                                            <input type="checkbox" name="set_default_address"
                                                   id="set_default_address">
                                            <span class="checkmark"></span>
                                            <span class="checkbox-label">Сделать основным адресом</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- Блок 3: Способ доставки -->
                        <section class="checkout-section">
                            <div class="section-header">
                                <h2><i class="fas fa-truck"></i> Способ доставки</h2>
                            </div>

                            <div class="section-body">
                                <div class="delivery-methods">
                                    <div class="delivery-method" data-price="0">
                                        <label class="method-select">
                                            <input type="radio" name="delivery_method"
                                                   value="pickup" data-price="0"
                                                   {% if not user.addresses.exists %}checked{% endif %}>
                                            <div class="method-content">
                                                <div class="method-icon">
                                                    <i class="fas fa-store"></i>
                                                </div>
                                                <div class="method-info">
                                                    <div class="method-name">Самовывоз</div>
                                                    <div class="method-description">
                                                        Заберите заказ из нашего магазина
                                                    </div>
                                                    <div class="method-details">
                                                        <i class="fas fa-map-pin"></i>
                                                        г. Москва, ул. Примерная, д. 1
                                                    </div>
                                                </div>
                                                <div class="method-price">
                                                    <span class="price-amount">0 ₽</span>
                                                    <span class="price-label">Бесплатно</span>
                                                </div>
                                            </div>
                                        </label>
                                    </div>

                                    <div class="delivery-method" data-price="300">
                                        <label class="method-select">
                                            <input type="radio" name="delivery_method"
                                                   value="courier" data-price="300"
                                                   {% if user.addresses.exists %}checked{% endif %}>
                                            <div class="method-content">
                                                <div class="method-icon">
                                                    <i class="fas fa-shipping-fast"></i>
                                                </div>
                                                <div class="method-info">
                                                    <div class="method-name">Курьерская доставка</div>
                                                    <div class="method-description">
                                                        Доставка курьером по Москве
                                                    </div>
                                                    <div class="method-details">
                                                        <i class="fas fa-clock"></i>
                                                        1-2 рабочих дня
                                                    </div>
                                                </div>
                                                <div class="method-price">
                                                    <span class="price-amount">300 ₽</span>
                                                </div>
                                            </div>
                                        </label>
                                    </div>

                                    <div class="delivery-method" data-price="250">
                                        <label class="method-select">
                                            <input type="radio" name="delivery_method"
                                                   value="post" data-price="250">
                                            <div class="method-content">
                                                <div class="method-icon">
                                                    <i class="fas fa-envelope"></i>
                                                </div>
                                                <div class="method-info">
                                                    <div class="method-name">Почта России</div>
                                                    <div class="method-description">
                                                        Доставка в отделение почты
                                                    </div>
                                                    <div class="method-details">
                                                        <i class="fas fa-clock"></i>
                                                        3-7 рабочих дней
                                                    </div>
                                                </div>
                                                <div class="method-price">
                                                    <span class="price-amount">250 ₽</span>
                                                </div>
                                            </div>
                                        </label>
                                    </div>

                                    <div class="delivery-method" data-price="350">
                                        <label class="method-select">
                                            <input type="radio" name="delivery_method"
                                                   value="cdek" data-price="350">
                                            <div class="method-content">
                                                <div class="method-icon">
                                                    <i class="fas fa-box"></i>
                                                </div>
                                                <div class="method-info">
                                                    <div class="method-name">СДЭК</div>
                                                    <div class="method-description">
                                                        Доставка в пункт выдачи
                                                    </div>
                                                    <div class="method-details">
                                                        <i class="fas fa-clock"></i>
                                                        2-4 рабочих дня
                                                    </div>
                                                </div>
                                                <div class="method-price">
                                                    <span class="price-amount">350 ₽</span>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- Блок 4: Способ оплаты -->
                        <section class="checkout-section">
                            <div class="section-header">
                                <h2><i class="fas fa-credit-card"></i> Способ оплаты</h2>
                            </div>

                            <div class="section-body">
                                <div class="payment-methods">
                                    <div class="payment-method">
                                        <label class="payment-select">
                                            <input type="radio" name="payment_method"
                                                   value="card" checked>
                                            <div class="payment-content">
                                                <div class="payment-icon">
                                                    <i class="fas fa-credit-card"></i>
                                                </div>
                                                <div class="payment-info">
                                                    <div class="payment-name">Картой онлайн</div>
                                                    <div class="payment-description">
                                                        Банковской картой Visa, MasterCard, МИР
                                                    </div>
                                                </div>
                                                <div class="payment-security">
                                                    <i class="fas fa-lock"></i>
                                                    <span>Безопасно</span>
                                                </div>
                                            </div>
                                        </label>
                                    </div>

                                    <div class="payment-method">
                                        <label class="payment-select">
                                            <input type="radio" name="payment_method"
                                                   value="cash">
                                            <div class="payment-content">
                                                <div class="payment-icon">
                                                    <i class="fas fa-money-bill-wave"></i>
                                                </div>
                                                <div class="payment-info">
                                                    <div class="payment-name">Наличными</div>
                                                    <div class="payment-description">
                                                        Оплата при получении заказа
                                                    </div>
                                                </div>
                                            </div>
                                        </label>
                                    </div>

                                    <div class="payment-method">
                                        <label class="payment-select">
                                            <input type="radio" name="payment_method"
                                                   value="invoice">
                                            <div class="payment-content">
                                                <div class="payment-icon">
                                                    <i class="fas fa-file-invoice"></i>
                                                </div>
                                                <div class="payment-info">
                                                    <div class="payment-name">Безналичный расчет</div>
                                                    <div class="payment-description">
                                                        Для юридических лиц
                                                    </div>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- Блок 5: Комментарий -->
                        <section class="checkout-section">
                            <div class="section-header">
                                <h2><i class="fas fa-comment-alt"></i> Комментарий к заказу</h2>
                            </div>

                            <div class="section-body">
                                <div class="form-group">
                                    <textarea name="order_notes" id="order_notes"
                                              class="form-input" rows="4"
                                              placeholder="Укажите дополнительные пожелания, время доставки, код домофона и т.д."></textarea>
                                </div>

                                <div class="form-options">
                                    <label class="checkbox">
                                        <input type="checkbox" name="subscribe_news" id="subscribe_news" checked>
                                        <span class="checkmark"></span>
                                        <span class="checkbox-label">
                                            Подписаться на новости и специальные предложения
                                        </span>
                                    </label>
                                </div>
                            </div>
                        </section>
                    </form>
                </div>

                <!-- Правая колонка: Итоги -->
                <div class="checkout-right">
                    <div class="order-summary">
                        <div class="summary-header">
                            <h3><i class="fas fa-receipt"></i> Ваш заказ</h3>
                        </div>

                        <div class="summary-body">
                            <!-- Список товаров -->
                            <div class="order-items">
                                {% for item in cart_items %}
                                <div class="order-item">
                                    <div class="item-image">
                                        {% if item.product.image %}
                                        <img src="{{ item.product.image.url }}"
                                             alt="{{ item.product.name }}">
                                        {% else %}
                                        <div class="image-placeholder">
                                            <i class="fas fa-image"></i>
                                        </div>
                                        {% endif %}
                                        <span class="item-quantity">{{ item.quantity }}</span>
                                    </div>
                                    <div class="item-info">
                                        <a href="{% url 'product_detail' item.product.id %}"
                                           class="item-name">
                                            {{ item.product.name|truncatechars:40 }}
                                        </a>
                                        {% if item.product.color %}
                                        <div class="item-variant">
                                            Цвет: {{ item.product.color }}
                                        </div>
                                        {% endif %}
                                        {% if item.product.size %}
                                        <div class="item-variant">
                                            Размер: {{ item.product.size }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="item-price">
                                        {{ item.get_total_price }} ₽
                                    </div>
                                </div>
                                {% endfor %}
                            </div>

                            <!-- Промокод -->
                            <div class="promo-code-section">
                                <div class="promo-input-group">
                                    <input type="text" id="promo_code"
                                           placeholder="Введите промокод"
                                           class="promo-input">
                                    <button type="button" id="apply_promo"
                                            class="btn-promo">
                                        Применить
                                    </button>
                                </div>
                                <div class="promo-error" id="promo_error"></div>
                            </div>

                            <!-- Итоги -->
                            <div class="order-totals">
                                <div class="total-row">
                                    <span>Товары ({{ cart.get_total_quantity }})</span>
                                    <span id="items-total">{{ subtotal }} ₽</span>
                                </div>

                                <div class="total-row">
                                    <span>Доставка</span>
                                    <span id="delivery-total">{{ delivery_cost }} ₽</span>
                                </div>

                                {% if discount_amount > 0 %}
                                <div class="total-row discount">
                                    <span>Скидка</span>
                                    <span>-{{ discount_amount }} ₽</span>
                                </div>
                                {% endif %}

                                <div class="total-row grand-total">
                                    <span>Итого к оплате</span>
                                    <span id="grand-total">{{ grand_total }} ₽</span>
                                </div>
                            </div>

                            <!-- Кнопка оформления -->
                            <div class="order-submit">
                                <button type="submit" form="checkout-form"
                                        class="btn-submit-order">
                                    <i class="fas fa-lock"></i>
                                    <span>Оформить заказ</span>
                                    <span id="final-price">{{ grand_total }} ₽</span>
                                </button>

                                <div class="security-note">
                                    <i class="fas fa-shield-alt"></i>
                                    <span>Безопасная оплата. Ваши данные защищены.</span>
                                </div>

                                <div class="terms-agreement">
                                    Нажимая кнопку, вы соглашаетесь с
                                    <a href="{% url 'contacts' %}#terms">Условиями использования</a>
                                    и
                                    <a href="{% url 'contacts' %}#privacy">Политикой конфиденциальности</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Гарантии -->
                    <div class="guarantees">
                        <div class="guarantee-item">
                            <i class="fas fa-undo-alt"></i>
                            <div class="guarantee-text">
                                <strong>Возврат 14 дней</strong>
                                <span>Без объяснения причины</span>
                            </div>
                        </div>
                        <div class="guarantee-item">
                            <i class="fas fa-truck"></i>
                            <div class="guarantee-text">
                                <strong>Быстрая доставка</strong>
                                <span>1-3 дня по Москве</span>
                            </div>
                        </div>
                        <div class="guarantee-item">
                            <i class="fas fa-headset"></i>
                            <div class="guarantee-text">
                                <strong>Поддержка 24/7</strong>
                                <span>Всегда на связи</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для редактирования адреса -->
<div class="modal" id="address-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Редактирование адреса</h3>
            <button type="button" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <!-- Форма будет загружаться через AJAX -->
        </div>
    </div>
</div>

<style>
/* Общие стили */
.checkout-page {
    min-height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding-bottom: 50px;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
}

/* Хлебные крошки */
.breadcrumbs {
    padding: 20px 0;
    color: white;
}

.breadcrumbs a {
    color: rgba(255, 255, 255, 0.8);
    text-decoration: none;
    transition: color 0.3s;
}

.breadcrumbs a:hover {
    color: white;
}

.breadcrumbs .current {
    color: white;
    font-weight: 500;
}

/* Шаги оформления */
.checkout-steps {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    margin: 40px 0 60px;
    flex-wrap: wrap;
}

.step {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 20px 30px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    color: white;
    min-width: 200px;
    transition: all 0.3s;
    backdrop-filter: blur(10px);
}

.step.active {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
}

.step.completed {
    background: rgba(255, 255, 255, 0.15);
}

.step-icon {
    font-size: 24px;
    width: 50px;
    height: 50px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.step-info {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.step-number {
    font-size: 12px;
    opacity: 0.8;
}

.step-title {
    font-size: 16px;
    font-weight: 600;
}

.step-divider {
    color: rgba(255, 255, 255, 0.3);
    font-size: 14px;
}

/* Основной контент */
.checkout-wrapper {
    background: white;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
}

.checkout-main {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 40px;
    padding: 40px;
}

.checkout-left {
    background: #f8f9fa;
    border-radius: 15px;
    padding: 30px;
}

.checkout-right {
    position: sticky;
    top: 40px;
    height: fit-content;
}

/* Секции формы */
.checkout-section {
    background: white;
    border-radius: 12px;
    margin-bottom: 25px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    border: 1px solid #e9ecef;
}

.section-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px 25px;
}

.section-header h2 {
    margin: 0;
    font-size: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.section-body {
    padding: 25px;
}

/* Формы */
.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #495057;
    font-size: 14px;
}

.form-input {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 15px;
    transition: all 0.3s;
    background: #f8f9fa;
}

.form-input:focus {
    border-color: #667eea;
    background: white;
    outline: none;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-hint {
    margin-top: 6px;
    font-size: 12px;
    color: #6c757d;
}

.form-error {
    color: #dc3545;
    font-size: 12px;
    margin-top: 5px;
    display: none;
}

.form-input.error {
    border-color: #dc3545;
}

/* Адреса */
.saved-addresses {
    margin-bottom: 25px;
}

.saved-addresses h4 {
    margin: 0 0 15px 0;
    color: #495057;
    font-size: 16px;
}

.address-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-height: 300px;
    overflow-y: auto;
    padding-right: 10px;
}

.address-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
    border: 2px solid #e9ecef;
    transition: all 0.3s;
}

.address-item:hover {
    border-color: #667eea;
    background: white;
}

.address-select {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 15px;
    cursor: pointer;
}

.address-select input[type="radio"] {
    width: 20px;
    height: 20px;
    margin: 0;
}

.address-content {
    flex: 1;
}

.address-name {
    font-weight: 600;
    color: #495057;
    margin-bottom: 5px;
}

.address-details {
    font-size: 14px;
    color: #6c757d;
    line-height: 1.4;
    margin-bottom: 3px;
}

.address-contact {
    font-size: 13px;
    color: #868e96;
}

.address-actions .btn-edit-address {
    background: none;
    border: none;
    color: #667eea;
    font-size: 16px;
    cursor: pointer;
    padding: 8px;
    border-radius: 6px;
    transition: all 0.3s;
}

.address-actions .btn-edit-address:hover {
    background: #667eea;
    color: white;
}

.btn-add-address {
    width: 100%;
    padding: 16px;
    background: white;
    color: #667eea;
    border: 2px dashed #667eea;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: all 0.3s;
}

.btn-add-address:hover {
    background: #667eea;
    color: white;
}

.new-address-form {
    margin-top: 25px;
    padding: 25px;
    background: #f8f9fa;
    border-radius: 10px;
    border: 1px solid #e9ecef;
}

.form-options {
    margin-top: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

/* Чекбоксы */
.checkbox {
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    font-size: 14px;
    color: #495057;
}

.checkbox input {
    display: none;
}

.checkmark {
    width: 20px;
    height: 20px;
    border: 2px solid #dee2e6;
    border-radius: 4px;
    position: relative;
    transition: all 0.3s;
}

.checkbox input:checked + .checkmark {
    background: #667eea;
    border-color: #667eea;
}

.checkbox input:checked + .checkmark::after {
    content: '✓';
    position: absolute;
    color: white;
    font-size: 12px;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

.checkbox-label {
    flex: 1;
}

/* Способы доставки */
.delivery-methods {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.delivery-method {
    border: 2px solid #e9ecef;
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.3s;
}

.delivery-method:hover {
    border-color: #667eea;
    transform: translateY(-2px);
}

.method-select {
    display: block;
    cursor: pointer;
}

.method-select input[type="radio"] {
    display: none;
}

.method-select input[type="radio"]:checked + .method-content {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    border-left: 4px solid #667eea;
}

.method-content {
    display: flex;
    align-items: center;
    gap: 20px;
    padding: 20px;
    background: white;
    transition: all 0.3s;
}

.method-icon {
    width: 50px;
    height: 50px;
    background: #667eea;
    color: white;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    flex-shrink: 0;
}

.method-info {
    flex: 1;
}

.method-name {
    font-weight: 600;
    color: #495057;
    margin-bottom: 5px;
    font-size: 16px;
}

.method-description {
    color: #6c757d;
    font-size: 14px;
    margin-bottom: 8px;
}

.method-details {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #868e96;
}

.method-price {
    text-align: right;
    min-width: 100px;
}

.price-amount {
    display: block;
    font-weight: 600;
    color: #495057;
    font-size: 18px;
}

.price-label {
    font-size: 12px;
    color: #28a745;
}

/* Способы оплаты */
.payment-methods {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.payment-method {
    border: 2px solid #e9ecef;
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.3s;
}

.payment-method:hover {
    border-color: #667eea;
}

.payment-select {
    display: block;
    cursor: pointer;
}

.payment-select input[type="radio"] {
    display: none;
}

.payment-select input[type="radio"]:checked + .payment-content {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    border-left: 4px solid #667eea;
}

.payment-content {
    display: flex;
    align-items: center;
    gap: 20px;
    padding: 20px;
    background: white;
    transition: all 0.3s;
}

.payment-icon {
    width: 50px;
    height: 50px;
    background: #28a745;
    color: white;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    flex-shrink: 0;
}

.payment-info {
    flex: 1;
}

.payment-name {
    font-weight: 600;
    color: #495057;
    margin-bottom: 5px;
    font-size: 16px;
}

.payment-description {
    color: #6c757d;
    font-size: 14px;
}

.payment-security {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #28a745;
    font-size: 13px;
    font-weight: 500;
}

/* Сводка заказа */
.order-summary {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    border: 1px solid #e9ecef;
    margin-bottom: 25px;
}

.summary-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 25px;
}

.summary-header h3 {
    margin: 0;
    font-size: 22px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.summary-body {
    padding: 25px;
}

.order-items {
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 25px;
    padding-right: 10px;
}

.order-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px 0;
    border-bottom: 1px solid #f1f3f5;
}

.order-item:last-child {
    border-bottom: none;
}

.item-image {
    position: relative;
    width: 60px;
    height: 60px;
    border-radius: 8px;
    overflow: hidden;
    flex-shrink: 0;
}

.item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.image-placeholder {
    width: 100%;
    height: 100%;
    background: #f1f3f5;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #adb5bd;
}

.item-quantity {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #667eea;
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
}

.item-info {
    flex: 1;
}

.item-name {
    display: block;
    color: #495057;
    text-decoration: none;
    font-weight: 500;
    margin-bottom: 5px;
    font-size: 14px;
    line-height: 1.4;
    transition: color 0.3s;
}

.item-name:hover {
    color: #667eea;
}

.item-variant {
    font-size: 12px;
    color: #868e96;
}

.item-price {
    font-weight: 600;
    color: #495057;
    font-size: 16px;
    min-width: 80px;
    text-align: right;
}

/* Промокод */
.promo-code-section {
    margin-bottom: 25px;
}

.promo-input-group {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}

.promo-input {
    flex: 1;
    padding: 14px 16px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 15px;
    transition: all 0.3s;
}

.promo-input:focus {
    border-color: #667eea;
    outline: none;
}

.btn-promo {
    padding: 14px 24px;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    white-space: nowrap;
}

.btn-promo:hover {
    background: #5a67d8;
    transform: translateY(-2px);
}

.promo-error {
    color: #dc3545;
    font-size: 13px;
    min-height: 18px;
}

/* Итоги */
.order-totals {
    border-top: 2px solid #f1f3f5;
    padding-top: 20px;
    margin-bottom: 25px;
}

.total-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
    font-size: 15px;
    color: #6c757d;
}

.total-row.grand-total {
    font-size: 20px;
    font-weight: 700;
    color: #495057;
    padding-top: 15px;
    border-top: 2px solid #667eea;
    margin-top: 15px;
    margin-bottom: 0;
}

.total-row.discount {
    color: #28a745;
}

#grand-total {
    color: #667eea;
}

/* Кнопка оформления */
.order-submit {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 25px;
    text-align: center;
}

.btn-submit-order {
    width: 100%;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: all 0.3s;
    margin-bottom: 20px;
}

.btn-submit-order:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
}

.btn-submit-order i {
    font-size: 20px;
}

.security-note {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    color: #6c757d;
    font-size: 14px;
    margin-bottom: 15px;
}

.security-note i {
    color: #28a745;
}

.terms-agreement {
    font-size: 12px;
    color: #868e96;
    line-height: 1.5;
}

.terms-agreement a {
    color: #667eea;
    text-decoration: none;
}

.terms-agreement a:hover {
    text-decoration: underline;
}

/* Гарантии */
.guarantees {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    border: 1px solid #e9ecef;
}

.guarantee-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px 0;
}

.guarantee-item:not(:last-child) {
    border-bottom: 1px solid #f1f3f5;
}

.guarantee-item i {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
}

.guarantee-text {
    display: flex;
    flex-direction: column;
    gap: 3px;
}

.guarantee-text strong {
    color: #495057;
    font-size: 14px;
}

.guarantee-text span {
    color: #868e96;
    font-size: 13px;
}

/* Модальное окно */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 10000;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.modal-content {
    background: white;
    border-radius: 15px;
    width: 100%;
    max-width: 500px;
    max-height: 90vh;
    overflow: hidden;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
}

.modal-header {
    padding: 25px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    font-size: 20px;
}

.modal-close {
    background: none;
    border: none;
    color: white;
    font-size: 28px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s;
}

.modal-close:hover {
    background: rgba(255, 255, 255, 0.2);
}

.modal-body {
    padding: 25px;
    max-height: calc(90vh - 100px);
    overflow-y: auto;
}

/* Адаптивность */
@media (max-width: 992px) {
    .checkout-main {
        grid-template-columns: 1fr;
        gap: 30px;
        padding: 30px;
    }

    .checkout-right {
        position: static;
    }

    .checkout-steps {
        gap: 15px;
        margin: 30px 0 40px;
    }

    .step {
        min-width: 150px;
        padding: 15px 20px;
    }
}

@media (max-width: 768px) {
    .checkout-main {
        padding: 20px;
    }

    .checkout-left {
        padding: 20px;
    }

    .step {
        min-width: 120px;
        padding: 12px 15px;
    }

    .step-icon {
        width: 40px;
        height: 40px;
        font-size: 18px;
    }

    .step-title {
        font-size: 14px;
    }

    .form-grid {
        grid-template-columns: 1fr;
    }

    .method-content,
    .payment-content {
        flex-wrap: wrap;
    }

    .method-price,
    .payment-security {
        width: 100%;
        text-align: left;
        margin-top: 10px;
    }
}

@media (max-width: 576px) {
    .checkout-steps {
        flex-direction: column;
        align-items: stretch;
    }

    .step {
        width: 100%;
    }

    .step-divider {
        display: none;
    }

    .section-body {
        padding: 20px;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Маска для телефона
    const phoneInput = document.getElementById('phone');
    phoneInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 0) {
            value = '+7 (' + value.substring(1, 4) + ') ' +
                    value.substring(4, 7) + '-' +
                    value.substring(7, 9) + '-' +
                    value.substring(9, 11);
        }
        e.target.value = value;
    });

    // Отображение формы нового адреса
    const showAddressFormBtn = document.getElementById('show-address-form');
    const newAddressForm = document.getElementById('new-address-form');

    showAddressFormBtn.addEventListener('click', function() {
        newAddressForm.style.display = newAddressForm.style.display === 'none' ? 'block' : 'none';
        if (newAddressForm.style.display === 'block') {
            showAddressFormBtn.innerHTML = '<i class="fas fa-times"></i> Скрыть форму адреса';
        } else {
            showAddressFormBtn.innerHTML = '<i class="fas fa-plus"></i> Добавить новый адрес';
        }
    });

    // Обновление стоимости доставки
    const deliveryMethods = document.querySelectorAll('input[name="delivery_method"]');
    const deliveryTotal = document.getElementById('delivery-total');
    const itemsTotal = parseFloat(document.getElementById('items-total').textContent);
    const grandTotal = document.getElementById('grand-total');
    const finalPrice = document.getElementById('final-price');

    deliveryMethods.forEach(method => {
        method.addEventListener('change', function() {
            const price = parseInt(this.getAttribute('data-price'));
            deliveryTotal.textContent = price + ' ₽';

            const total = itemsTotal + price;
            grandTotal.textContent = total + ' ₽';
            finalPrice.textContent = total + ' ₽';
        });
    });

    // Применение промокода
    const applyPromoBtn = document.getElementById('apply_promo');
    const promoInput = document.getElementById('promo_code');
    const promoError = document.getElementById('promo_error');

    applyPromoBtn.addEventListener('click', function() {
        const promoCode = promoInput.value.trim();

        if (!promoCode) {
            promoError.textContent = 'Введите промокод';
            return;
        }

        // Имитация AJAX запроса
        promoError.textContent = '';
        applyPromoBtn.disabled = true;
        applyPromoBtn.textContent = 'Проверка...';

        setTimeout(() => {
            // В реальном приложении здесь будет AJAX запрос к серверу
            if (promoCode === 'SPORT10') {
                const discount = itemsTotal * 0.1;
                const newTotal = itemsTotal - discount + parseInt(deliveryTotal.textContent);

                // Добавляем строку скидки если ее нет
                let discountRow = document.querySelector('.total-row.discount');
                if (!discountRow) {
                    discountRow = document.createElement('div');
                    discountRow.className = 'total-row discount';
                    discountRow.innerHTML = `
                        <span>Скидка 10%</span>
                        <span>-${discount.toFixed(0)} ₽</span>
                    `;
                    document.querySelector('.order-totals').insertBefore(
                        discountRow,
                        document.querySelector('.grand-total')
                    );
                }

                grandTotal.textContent = newTotal.toFixed(0) + ' ₽';
                finalPrice.textContent = newTotal.toFixed(0) + ' ₽';

                promoError.style.color = '#28a745';
                promoError.textContent = 'Промокод успешно применен!';
                promoInput.disabled = true;
                applyPromoBtn.textContent = 'Применено';
            } else {
                promoError.textContent = 'Неверный промокод';
                applyPromoBtn.textContent = 'Применить';
            }

            applyPromoBtn.disabled = false;
        }, 1000);
    });

    // Валидация формы
    const form = document.getElementById('checkout-form');
    form.addEventListener('submit', function(e) {
        let isValid = true;

        // Проверка обязательных полей
        const requiredFields = form.querySelectorAll('[required]');
        requiredFields.forEach(field => {
            field.classList.remove('error');
            const errorElement = field.parentElement.querySelector('.form-error');

            if (!field.value.trim()) {
                field.classList.add('error');
                errorElement.textContent = 'Это поле обязательно для заполнения';
                errorElement.style.display = 'block';
                isValid = false;
            } else {
                errorElement.style.display = 'none';

                // Дополнительная валидация email
                if (field.type === 'email') {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(field.value)) {
                        field.classList.add('error');
                        errorElement.textContent = 'Введите корректный email';
                        errorElement.style.display = 'block';
                        isValid = false;
                    }
                }

                // Дополнительная валидация телефона
                if (field.type === 'tel') {
                    const phoneRegex = /^\+7\s\(\d{3}\)\s\d{3}-\d{2}-\d{2}$/;
                    if (!phoneRegex.test(field.value)) {
                        field.classList.add('error');
                        errorElement.textContent = 'Введите корректный номер телефона';
                        errorElement.style.display = 'block';
                        isValid = false;
                    }
                }
            }
        });

        // Проверка выбора адреса или заполнения формы нового адреса
        const addressSelected = form.querySelector('input[name="address_id"]:checked');
        const newAddressFormVisible = newAddressForm.style.display === 'block';

        if (!addressSelected && newAddressFormVisible) {
            // Проверяем заполненность формы нового адреса
            const newAddressRequired = newAddressForm.querySelectorAll('[required]');
            newAddressRequired.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('error');
                    field.parentElement.querySelector('.form-error').style.display = 'block';
                    isValid = false;
                }
            });
        }

        if (!isValid) {
            e.preventDefault();
            // Прокрутка к первой ошибке
            const firstError = form.querySelector('.error');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstError.focus();
            }
        }
    });

    // Модальное окно редактирования адреса
    const modal = document.getElementById('address-modal');
    const modalClose = modal.querySelector('.modal-close');

    window.editAddress = function(addressId) {
        // Здесь должна быть загрузка формы через AJAX
        const modalBody = modal.querySelector('.modal-body');
        modalBody.innerHTML = `
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i> Загрузка...
            </div>
        `;

        modal.style.display = 'flex';

        // Имитация AJAX запроса
        setTimeout(() => {
            modalBody.innerHTML = `
                <form id="edit-address-form">
                    <div class="form-group">
                        <label for="edit_address_name">Название адреса</label>
                        <input type="text" id="edit_address_name" class="form-input" value="Дом">
                    </div>
                    <div class="form-group">
                        <label for="edit_address_city">Город</label>
                        <input type="text" id="edit_address_city" class="form-input" value="Москва">
                    </div>
                    <div class="form-group">
                        <label for="edit_address_street">Улица, дом, квартира</label>
                        <textarea id="edit_address_street" class="form-input" rows="2">ул. Пушкина, д. 10, кв. 25</textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn-save">Сохранить</button>
                        <button type="button" class="btn-cancel" onclick="closeModal()">Отмена</button>
                    </div>
                </form>
            `;
        }, 500);
    };

    modalClose.addEventListener('click', closeModal);
    window.closeModal = function() {
        modal.style.display = 'none';
    };

    // Закрытие модального окна при клике вне его
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal();
        }
    });
});
</script>
{% endblock %}
